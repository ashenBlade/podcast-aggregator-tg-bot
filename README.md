# Podcast Aggregator Telegram Bot

Телеграм бот для ведения телеграм канала по тематике подкастов

# Алгоритм работы

Бот с определенным интервалом опрашивает сайты с подкастами на наличие новых.
При обнаружении новых, они отправляются в указанный телеграм чат:
- если обнаружен новый эпизод, то создается новое сообщение
- если обнаружен новый источник, то обновляются ссылки на эпизоды

# Как запустить

Конфигурация передается через переменные окружения:
- `POLL_INTERVAL_HOURS` - интервал работы приложения в часах. По умолчанию, 1. Не может быть отрицательным.
- `BOT_TOKEN` - токен телеграм бота. Обязателен
- `CHAT_ID` - ID чата, куда будут присылаться новые подкасты
- `SEED_PODCASTS_FILE` - путь к файлу с сидами подкастов, для изначального заполнения. Необязателен.
- `DB_FILE` - путь к файлу БД с подкастами и треками. По умолчанию, 'podcasts.sqlite' в текущей директории проекта. Если не существовало, то создается новый и схема инициализируется

Бот разрабатывался для запуска в контейнере. 
Как он будет себя вести вне его - мне не известно.

Пример запуска можно найти в [docker-compose.yaml](./docker-compose.yaml).

При запуске создается внутренняя база данных для хранения самих подкастов и треков, которые уже были обработаны.
БД хранится в контейнере, по пути 

# Работа с подкастами

На данный момент можно добавлять подкасты из 3 провайдеров (откуда брать новые треки): Яндекс.Музыка, Google подкасты, Apple подкасты.
Подкасты можно добавить с помощью yaml файла, в котором нужно указать название подкаста и ID, указанного в провайдере.

## База данных подкастов

Сами подкасты хранятся в SQLite базе данных локально. 
БД нужна чтобы, отслеживать отправленные треки и обновлять их при необходимости.

Схема базы данных указана в [db/schema.sql](db/schema.sql).
Файл базы данных указывается в переменной окружения `DB_FILE`. 

Если она не указана, то создается файл БД 'podcasts.sqlite' в рабочей директории.

Если важно сохранение состояния, то можно смаунтить путь к директории и в `DB_FILE` указать файл в этой директории.

На старте приложения происходит попытка инициализации схемы БД. 
Если она неудачна, то предполагается, что БД уже инициализирована и работа продолжается.

## Изначальное добавление подкастов

Изначальные подкасты можно указывать через файл podcasts.yaml. 
Этот файл можно замаунтить и указать через переменную окружения `SEED_PODCASTS_FILE`.
Если он не указан, то БД заполнена не будет, но работа будет продолжена.

В этом файле должны быть:
- либо верхне уровневый массив объекта подкаста
- либо поле 'podcasts' с массивом объекта подкаста

Объект подкаста представляется структурой из 4 полей:
- 'name' - название подкаста
- 'yandex' - ID подкаста в Яндекс.Музыке
- 'google' - ID подкаста в Гугл Подкастах
- 'apple' - ID подкаста в Apple подкастах

Поле 'name' единственное обязательное. Остальные могут быть не указаны, это означает null.

Причем, любой ID обязан быть уникальным для своего провайдера, но 'name' уникальным может не быть (может повторяться).
Пример можно найти в файле [db/seeds/podcasts.yaml](db/seeds/podcasts.yaml).

В случае, если при попытке добавления записи нашлась конфликтующая (одинаковые ID у провайдеров), 
то эта запись не добавляется, но другие будут добавлены. 
Если появились новые ID для другого провайдера, то нужно пересоздавать БД, либо обновлять вручную.

## Яндекс.Музыка

ID подкаста в Яндекс.Музыке:
1. Получить URL страницы подкаста - [https://music.yandex.ru/album/7570122](https://music.yandex.ru/album/7570122)
2. Из пути получить ID альбома, число после /album/ - 7570122

Представление ID - число

## Гугл Подкасты

ID подкаста в Гугл Подкастах:
1. Получить URL страницы подкаста - [https://podcasts.google.com/feed/aHR0cHM6Ly9mZWVkcy5zb3VuZGNsb3VkLmNvbS91c2Vycy9zb3VuZGNsb3VkOnVzZXJzOjI5MTMzNzEwNi9zb3VuZHMucnNz](https://podcasts.google.com/feed/aHR0cHM6Ly9mZWVkcy5zb3VuZGNsb3VkLmNvbS91c2Vycy9zb3VuZGNsb3VkOnVzZXJzOjI5MTMzNzEwNi9zb3VuZHMucnNz)
2. Из пути получить ID фида, строка после /feed/ - aHR0cHM6Ly9mZWVkcy5zb3VuZGNsb3VkLmNvbS91c2Vycy9zb3VuZGNsb3VkOnVzZXJzOjI5MTMzNzEwNi9zb3VuZHMucnNz

Представление ID - закодированная Base64 строка адреса из feeds.soundcloud.com. 
ID из примера десериализуется в [https://feeds.soundcloud.com/users/soundcloud:users:291337106/sounds.rss](https://feeds.soundcloud.com/users/soundcloud:users:291337106/sounds.rss)

## Apple Подкасты

ID подкаста в Apple Подкастах:
1. Получить URL страницы подкаста - [https://podcasts.apple.com/ru/podcast/podlodka-podcast/id1209828744](https://podcasts.apple.com/ru/podcast/podlodka-podcast/id1209828744)
2. Из пути получить ID подкаста, строка после /podcast/{строка названия подкаста}/ - id1209828744

Представление ID - строка с 'id' в начале и числом после нее

# Замечания

Когда могут возникнуть ошибки:
- Передаваемые ID не проверяются на корректность. Это лежит на плечах пользователя
- Если подкаст будет удален, то приложение начнет работать неправильно. Такое уже случалось, когда Scalalaz Podcast был удален - несколько дней не публиковались подкасты
- Для работы, приложение использует парсинг HTML. В некоторых местах, полагается на эмпирические данные, например, вложенность 'div' тегов. Если верстка изменится, то приложение начнет сбоить.

